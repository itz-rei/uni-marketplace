<!DOCTYPE html>
<html>
<head>
  <title>UST-L Vendor Locator</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet/dist/leaflet.css" 
  />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Center map at UST-L
    var ustlCoords = [13.164463065659673, 123.7491774937675];
    var map = L.map('map').setView(ustlCoords, 17);

    // Tile Layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Restrict map view only to UST-L area (bounds)
    var bounds = [
      [13.1625, 123.7465], // Southwest corner
      [13.1665, 123.7510]  // Northeast corner
    ];
    map.setMaxBounds(bounds);
    map.setMinZoom(17);

    // Example vendor locations (you can add more later from DB)
    var vendors = [
      { name: "Vendor A", coords: [13.1640, 123.7485] },
      { name: "Vendor B", coords: [13.1650, 123.7500] },
      { name: "Vendor C", coords: [13.1647, 123.7478] }
    ];

    // Add vendor markers
    vendors.forEach(v => {
      L.marker(v.coords).addTo(map)
        .bindPopup(v.name);
    });

    // Function to calculate nearest vendor
    function findNearestVendor(userLatLng) {
      let nearest = null;
      let minDistance = Infinity;

      vendors.forEach(v => {
        let vendorLatLng = L.latLng(v.coords);
        let distance = userLatLng.distanceTo(vendorLatLng); // meters
        if (distance < minDistance) {
          minDistance = distance;
          nearest = v;
        }
      });

      return nearest;
    }

    // Get User Location
    map.locate({setView: true, maxZoom: 18});

    function onLocationFound(e) {
      var userMarker = L.marker(e.latlng).addTo(map)
        .bindPopup("You are here").openPopup();

      // Find nearest vendor
      var nearest = findNearestVendor(e.latlng);

      if (nearest) {
        L.polyline([e.latlng, nearest.coords], {color: 'blue'}).addTo(map);
        L.marker(nearest.coords, {icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [30,30]})})
          .addTo(map)
          .bindPopup("Nearest Vendor: " + nearest.name)
          .openPopup();
      }
    }

    map.on('locationfound', onLocationFound);

    function onLocationError(e) {
      alert(e.message);
    }

    map.on('locationerror', onLocationError);
  </script>
</body>
</html>
